{
  "path": "agents/tests/testing.md",
  "title": "ExoFrame Test Development Guidelines",
  "vecs": [
    {
      "text": "# ExoFrame Test Development Guidelines\n\nKey points\n\n- Use `initTestDbService()` and `createCliTestContext()` to centralize db+tempdir setup\n- Use `withEnv()` for temporary env var changes in tests\n- **Mocking**: Use `MockLLMProvider` for deterministic agent testing (avoid real API calls).\n- **Integration**: Use `TestEnvironment.create()` to scaffold full workspace/DB structures.\n- **Leases**: File locking integration tests live in `tests/execution_loop_test.ts`.\n\n- Prefer `createCliTestContext()` for CLI tests and call returned `cleanup()` in `afterEach`\n\nCanonical prompt (short):\n\"You are a test-writing assistant for ExoFrame. List failing test names and assertions first, using `initTestDbService()` or `createCliTestContext()` where appropriate.\"\n\nExamples",
      "vector": [
        0.1568627450980392,
        0.34901960784313724,
        0.9568627450980393,
        0.7254901960784313,
        0.10980392156862745,
        0.592156862745098,
        0.3176470588235294,
        0.7411764705882353,
        0.13725490196078433,
        0.4666666666666667,
        0.5411764705882353,
        0.6862745098039216,
        0.8470588235294118,
        0.2901960784313726,
        0.8862745098039215,
        0.9568627450980393,
        0.8313725490196079,
        0.4117647058823529,
        0.5568627450980392,
        0.44313725490196076,
        0.596078431372549,
        0.6431372549019608,
        0.4666666666666667,
        0.2627450980392157,
        0.9254901960784314,
        0.38823529411764707,
        0.9294117647058824,
        0.08627450980392157,
        0.8588235294117647,
        0.8745098039215686,
        0.8352941176470589,
        0.10980392156862745,
        0.1568627450980392,
        0.34901960784313724,
        0.9568627450980393,
        0.7254901960784313,
        0.10980392156862745,
        0.592156862745098,
        0.3176470588235294,
        0.7411764705882353,
        0.13725490196078433,
        0.4666666666666667,
        0.5411764705882353,
        0.6862745098039216,
        0.8470588235294118,
        0.2901960784313726,
        0.8862745098039215,
        0.9568627450980393,
        0.8313725490196079,
        0.4117647058823529,
        0.5568627450980392,
        0.44313725490196076,
        0.596078431372549,
        0.6431372549019608,
        0.4666666666666667,
        0.2627450980392157,
        0.9254901960784314,
        0.38823529411764707,
        0.9294117647058824,
        0.08627450980392157,
        0.8588235294117647,
        0.8745098039215686,
        0.8352941176470589,
        0.10980392156862745
      ]
    },
    {
      "text": "- Example prompt: \"Write tests that verify PlanWriter handles missing files and empty JSON. Use `initTestDbService()` and ensure cleanup is called.\"\n\nExample snippet\n\n```typescript\nconst { db, tempDir, cleanup } = await initTestDbService();\ntry {\n  // test actions\n} finally {\n  await cleanup();\n}\n```\n\nExamples section\n\n- Example prompt: \"Provide 3 failing unit tests showing how PlanWriter handles malformed plan.json and missing permissions.\"\n\n## Full migration: Test guidelines (extended)\n\n### Coverage-Driven TDD\n\nTarget: Minimum 70% branch coverage on new features. Request an implementation with a coverage target and add tests to cover uncovered branches using `deno test --coverage`.\n\n### Advanced Testing Patterns",
      "vector": [
        1,
        0.9372549019607843,
        0.5529411764705883,
        0.8,
        0.7294117647058823,
        0.48627450980392156,
        0.6784313725490196,
        0.6039215686274509,
        0.403921568627451,
        0.8470588235294118,
        0.11372549019607843,
        0.23137254901960785,
        0.3254901960784314,
        0.13333333333333333,
        0.7450980392156863,
        0.2,
        0.7686274509803922,
        0.09019607843137255,
        0.6196078431372549,
        0.8588235294117647,
        0.4627450980392157,
        0.6588235294117647,
        0.8,
        0.9803921568627451,
        0.08627450980392157,
        0.20392156862745098,
        0.35294117647058826,
        0.3607843137254902,
        0.2627450980392157,
        0.5803921568627451,
        0.403921568627451,
        0.36470588235294116,
        1,
        0.9372549019607843,
        0.5529411764705883,
        0.8,
        0.7294117647058823,
        0.48627450980392156,
        0.6784313725490196,
        0.6039215686274509,
        0.403921568627451,
        0.8470588235294118,
        0.11372549019607843,
        0.23137254901960785,
        0.3254901960784314,
        0.13333333333333333,
        0.7450980392156863,
        0.2,
        0.7686274509803922,
        0.09019607843137255,
        0.6196078431372549,
        0.8588235294117647,
        0.4627450980392157,
        0.6588235294117647,
        0.8,
        0.9803921568627451,
        0.08627450980392157,
        0.20392156862745098,
        0.35294117647058826,
        0.3607843137254902,
        0.2627450980392157,
        0.5803921568627451,
        0.403921568627451,
        0.36470588235294116
      ]
    },
    {
      "text": "- **Refactoring & Duplication**: Use `npx jscpd src tests` to find duplicated test setup code. Extract helpers (e.g., `GitTestHelper`, `ToolRegistryTestHelper`) to keep tests DRY.\n- **Paranoid Security Testing**: Ask agents to write \"paranoid\" tests: path traversal, command injection, symlink escapes. Whitelists beat blacklists.\n- **Performance Testing**: Don't guess—measure. Ask agents to write benchmarks or load tests to verify async behavior (e.g., batched logging).\n\n### Test Organization and Deduplication\n\n- `tests/cli/` - CLI command tests\n- `tests/services/` - Service unit tests\n- `tests/integration/` - End-to-end workflows\n- `tests/helpers/` - Shared test utilities\n\nDeduplication checklist:",
      "vector": [
        0.5764705882352941,
        0.3764705882352941,
        0.36470588235294116,
        0.9058823529411765,
        0.9647058823529412,
        0.17647058823529413,
        0.2235294117647059,
        0.3843137254901961,
        0.07450980392156863,
        0.12549019607843137,
        0.2627450980392157,
        0.611764705882353,
        0.9647058823529412,
        0.803921568627451,
        0.9725490196078431,
        0.1607843137254902,
        0.01568627450980392,
        0.5607843137254902,
        0.30980392156862746,
        0.42745098039215684,
        0.3176470588235294,
        0.1803921568627451,
        0.6705882352941176,
        0.5215686274509804,
        0.3607843137254902,
        0.2,
        0.9098039215686274,
        0.9529411764705882,
        0.807843137254902,
        0.4235294117647059,
        0.35294117647058826,
        0.6901960784313725,
        0.5764705882352941,
        0.3764705882352941,
        0.36470588235294116,
        0.9058823529411765,
        0.9647058823529412,
        0.17647058823529413,
        0.2235294117647059,
        0.3843137254901961,
        0.07450980392156863,
        0.12549019607843137,
        0.2627450980392157,
        0.611764705882353,
        0.9647058823529412,
        0.803921568627451,
        0.9725490196078431,
        0.1607843137254902,
        0.01568627450980392,
        0.5607843137254902,
        0.30980392156862746,
        0.42745098039215684,
        0.3176470588235294,
        0.1803921568627451,
        0.6705882352941176,
        0.5215686274509804,
        0.3607843137254902,
        0.2,
        0.9098039215686274,
        0.9529411764705882,
        0.807843137254902,
        0.4235294117647059,
        0.35294117647058826,
        0.6901960784313725
      ]
    },
    {
      "text": "1. Search for similar test file names\n2. Compare test case names for duplicates\n3. Merge unique cases into canonical location\n4. Delete duplicate files\n\n### Security Tests as First-Class Citizens\n\nEvery security boundary needs explicit tests. Label security tests with `[security]` and include tests for path traversal, shell injection, network exfiltration, and env leakage.\n\n### Database Initialization\n\n✅ DO: Use `initTestDbService()` for DatabaseService tests. Prefer `initActivityTableSchema()` for reconnection tests and avoid raw SQL table creation in test files.\n\n### CLI Test Context — Recommended Pattern\n\nUse `createCliTestContext()` to centralize DB + tempdir setup for CLI tests. Always call returned `cleanup()` in `afterEach` to avoid leaking resources.",
      "vector": [
        0.4196078431372549,
        0.050980392156862744,
        0.9490196078431372,
        0.49019607843137253,
        0.1803921568627451,
        0.4,
        0.043137254901960784,
        0.8156862745098039,
        0.8901960784313725,
        0.9764705882352941,
        0.20784313725490197,
        0.7450980392156863,
        0.11764705882352941,
        0.40784313725490196,
        0.6470588235294118,
        0.36470588235294116,
        0.45098039215686275,
        0.788235294117647,
        0.7294117647058823,
        0.00784313725490196,
        0.807843137254902,
        0.17647058823529413,
        0.5411764705882353,
        0.24705882352941178,
        0.7098039215686275,
        0.2,
        0.592156862745098,
        0.9568627450980393,
        0.30196078431372547,
        0.6588235294117647,
        0.3176470588235294,
        0.07058823529411765,
        0.4196078431372549,
        0.050980392156862744,
        0.9490196078431372,
        0.49019607843137253,
        0.1803921568627451,
        0.4,
        0.043137254901960784,
        0.8156862745098039,
        0.8901960784313725,
        0.9764705882352941,
        0.20784313725490197,
        0.7450980392156863,
        0.11764705882352941,
        0.40784313725490196,
        0.6470588235294118,
        0.36470588235294116,
        0.45098039215686275,
        0.788235294117647,
        0.7294117647058823,
        0.00784313725490196,
        0.807843137254902,
        0.17647058823529413,
        0.5411764705882353,
        0.24705882352941178,
        0.7098039215686275,
        0.2,
        0.592156862745098,
        0.9568627450980393,
        0.30196078431372547,
        0.6588235294117647,
        0.3176470588235294,
        0.07058823529411765
      ]
    },
    {
      "text": "### Integration TestEnvironment — Recommended Pattern\n\nUse `TestEnvironment.create()` for full integration tests that require workspace layout, DB, and optional git initialization. Prefer small, focused integration tests that exercise end-to-end behavior with deterministic teardown.\n\n### CI (GitHub Actions) — Common Pitfalls",
      "vector": [
        0.4117647058823529,
        0.803921568627451,
        0.6745098039215687,
        0.09019607843137255,
        0.5294117647058824,
        0.8549019607843137,
        0.0196078431372549,
        0.8,
        0.47843137254901963,
        0.44313725490196076,
        0.8117647058823529,
        0.6235294117647059,
        0.34901960784313724,
        0.5019607843137255,
        0.1803921568627451,
        0.7803921568627451,
        0.23137254901960785,
        0.5529411764705883,
        0.24705882352941178,
        0.1450980392156863,
        0.16862745098039217,
        0.3607843137254902,
        0.5215686274509804,
        0.21176470588235294,
        0.3607843137254902,
        0.9019607843137255,
        0.17254901960784313,
        0.43137254901960786,
        0.24313725490196078,
        0.3254901960784314,
        0.14901960784313725,
        0.34901960784313724,
        0.4117647058823529,
        0.803921568627451,
        0.6745098039215687,
        0.09019607843137255,
        0.5294117647058824,
        0.8549019607843137,
        0.0196078431372549,
        0.8,
        0.47843137254901963,
        0.44313725490196076,
        0.8117647058823529,
        0.6235294117647059,
        0.34901960784313724,
        0.5019607843137255,
        0.1803921568627451,
        0.7803921568627451,
        0.23137254901960785,
        0.5529411764705883,
        0.24705882352941178,
        0.1450980392156863,
        0.16862745098039217,
        0.3607843137254902,
        0.5215686274509804,
        0.21176470588235294,
        0.3607843137254902,
        0.9019607843137255,
        0.17254901960784313,
        0.43137254901960786,
        0.24313725490196078,
        0.3254901960784314,
        0.14901960784313725,
        0.34901960784313724
      ]
    },
    {
      "text": "- Treat `CI` as a truthy flag (`CI=true` on GitHub Actions), not strictly `\"1\"`.\n  - Prefer the shared helpers in `tests/helpers/env.ts` (`isCi()`, `isTruthyEnv()`).\n- When CI guard is active, paid LLM providers are intentionally disabled unless explicitly opted in.\n  - Expect mock behavior unless `EXO_ENABLE_PAID_LLM=1` is set.\n  - Tests that assert provider selection should include a CI-guard branch (e.g., accept `mock-provider` or `CI-protected ...`).\n- Avoid requiring compiled binaries in tests.\n  - If you need to run the CLI from a temp workspace, prefer:\n    - `new Deno.Command(Deno.execPath(), { args: [\"run\", \"--allow-all\", \"--config\", <repo>/deno.json, <repo>/src/cli/exoctl.ts, ...] })`\n  - This keeps behavior consistent between local runs and CI without extra build steps.\n\n---",
      "vector": [
        0.8705882352941177,
        0.49019607843137253,
        0.34509803921568627,
        0.4745098039215686,
        0.8431372549019608,
        0.043137254901960784,
        0.043137254901960784,
        0.9137254901960784,
        0.6196078431372549,
        0.6196078431372549,
        0.3137254901960784,
        0.19215686274509805,
        0.6196078431372549,
        0.9686274509803922,
        0.08235294117647059,
        0.1450980392156863,
        0.8666666666666667,
        0.3686274509803922,
        0.796078431372549,
        0.0784313725490196,
        0.9803921568627451,
        0.596078431372549,
        0.3333333333333333,
        0.5294117647058824,
        0.21568627450980393,
        0.7803921568627451,
        0.24705882352941178,
        0.35294117647058826,
        0.023529411764705882,
        0.803921568627451,
        0.9294117647058824,
        0.9725490196078431,
        0.8705882352941177,
        0.49019607843137253,
        0.34509803921568627,
        0.4745098039215686,
        0.8431372549019608,
        0.043137254901960784,
        0.043137254901960784,
        0.9137254901960784,
        0.6196078431372549,
        0.6196078431372549,
        0.3137254901960784,
        0.19215686274509805,
        0.6196078431372549,
        0.9686274509803922,
        0.08235294117647059,
        0.1450980392156863,
        0.8666666666666667,
        0.3686274509803922,
        0.796078431372549,
        0.0784313725490196,
        0.9803921568627451,
        0.596078431372549,
        0.3333333333333333,
        0.5294117647058824,
        0.21568627450980393,
        0.7803921568627451,
        0.24705882352941178,
        0.35294117647058826,
        0.023529411764705882,
        0.803921568627451,
        0.9294117647058824,
        0.9725490196078431
      ]
    }
  ]
}