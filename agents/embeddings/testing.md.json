{
  "path": "agents/tests/testing.md",
  "title": "ExoFrame Test Development Guidelines",
  "vecs": [
    {
      "text": "# ExoFrame Test Development Guidelines\n\nKey points\n- Use `initTestDbService()` and `createCliTestContext()` to centralize db+tempdir setup\n- Use `withEnv()` for temporary env var changes in tests\n- **Mocking**: Use `MockLLMProvider` for deterministic agent testing (avoid real API calls).\n- **Integration**: Use `TestEnvironment.create()` to scaffold full workspace/DB structures.\n- **Leases**: File locking integration tests live in `tests/execution_loop_test.ts`.\n\n- Prefer `createCliTestContext()` for CLI tests and call returned `cleanup()` in `afterEach`\n\nCanonical prompt (short):\n\"You are a test-writing assistant for ExoFrame. List failing test names and assertions first, using `initTestDbService()` or `createCliTestContext()` where appropriate.\"",
      "vector": [
        0.06666666666666667,
        0.32941176470588235,
        0.5764705882352941,
        0.4196078431372549,
        0.3764705882352941,
        0.16862745098039217,
        0.13725490196078433,
        0.8549019607843137,
        0.24313725490196078,
        0.7647058823529411,
        0.11372549019607843,
        0.3843137254901961,
        0.14901960784313725,
        0.24313725490196078,
        0.7529411764705882,
        0.26666666666666666,
        0.1411764705882353,
        0.19607843137254902,
        0.4823529411764706,
        0.2627450980392157,
        0.4588235294117647,
        0.615686274509804,
        0.4745098039215686,
        0.01568627450980392,
        0.8627450980392157,
        0.9450980392156862,
        0.7176470588235294,
        0.3254901960784314,
        0.03529411764705882,
        0.3764705882352941,
        0.25098039215686274,
        0.5411764705882353,
        0.06666666666666667,
        0.32941176470588235,
        0.5764705882352941,
        0.4196078431372549,
        0.3764705882352941,
        0.16862745098039217,
        0.13725490196078433,
        0.8549019607843137,
        0.24313725490196078,
        0.7647058823529411,
        0.11372549019607843,
        0.3843137254901961,
        0.14901960784313725,
        0.24313725490196078,
        0.7529411764705882,
        0.26666666666666666,
        0.1411764705882353,
        0.19607843137254902,
        0.4823529411764706,
        0.2627450980392157,
        0.4588235294117647,
        0.615686274509804,
        0.4745098039215686,
        0.01568627450980392,
        0.8627450980392157,
        0.9450980392156862,
        0.7176470588235294,
        0.3254901960784314,
        0.03529411764705882,
        0.3764705882352941,
        0.25098039215686274,
        0.5411764705882353
      ]
    },
    {
      "text": "Examples\n- Example prompt: \"Write tests that verify PlanWriter handles missing files and empty JSON. Use `initTestDbService()` and ensure cleanup is called.\"\n\nExample snippet\n```typescript\nconst { db, tempDir, cleanup } = await initTestDbService();\ntry {\n  // test actions\n} finally {\n  await cleanup();\n}\n```\n\nExamples section\n- Example prompt: \"Provide 3 failing unit tests showing how PlanWriter handles malformed plan.json and missing permissions.\"\n\n## Full migration: Test guidelines (extended)\n\n### Coverage-Driven TDD\n\nTarget: Minimum 70% branch coverage on new features. Request an implementation with a coverage target and add tests to cover uncovered branches using `deno test --coverage`.\n\n### Advanced Testing Patterns",
      "vector": [
        0.2980392156862745,
        0.0392156862745098,
        0.9647058823529412,
        0.5607843137254902,
        0.34509803921568627,
        0.4117647058823529,
        0.23921568627450981,
        0.2627450980392157,
        0.37254901960784315,
        0.21568627450980393,
        0.7607843137254902,
        0.28627450980392155,
        0.043137254901960784,
        0.5294117647058824,
        0.1803921568627451,
        0.9882352941176471,
        0.8705882352941177,
        0.5450980392156862,
        0.27058823529411763,
        0.47058823529411764,
        0.9529411764705882,
        0.9803921568627451,
        0.2823529411764706,
        0.5098039215686274,
        0.4392156862745098,
        0.5490196078431373,
        1,
        0.6509803921568628,
        0,
        0.7607843137254902,
        0.5529411764705883,
        0.058823529411764705,
        0.2980392156862745,
        0.0392156862745098,
        0.9647058823529412,
        0.5607843137254902,
        0.34509803921568627,
        0.4117647058823529,
        0.23921568627450981,
        0.2627450980392157,
        0.37254901960784315,
        0.21568627450980393,
        0.7607843137254902,
        0.28627450980392155,
        0.043137254901960784,
        0.5294117647058824,
        0.1803921568627451,
        0.9882352941176471,
        0.8705882352941177,
        0.5450980392156862,
        0.27058823529411763,
        0.47058823529411764,
        0.9529411764705882,
        0.9803921568627451,
        0.2823529411764706,
        0.5098039215686274,
        0.4392156862745098,
        0.5490196078431373,
        1,
        0.6509803921568628,
        0,
        0.7607843137254902,
        0.5529411764705883,
        0.058823529411764705
      ]
    },
    {
      "text": "- **Refactoring & Duplication**: Use `npx jscpd src tests` to find duplicated test setup code. Extract helpers (e.g., `GitTestHelper`, `ToolRegistryTestHelper`) to keep tests DRY.\n- **Paranoid Security Testing**: Ask agents to write \"paranoid\" tests: path traversal, command injection, symlink escapes. Whitelists beat blacklists.\n- **Performance Testing**: Don't guess—measure. Ask agents to write benchmarks or load tests to verify async behavior (e.g., batched logging).\n\n### Test Organization and Deduplication\n\n- `tests/cli/` - CLI command tests\n- `tests/services/` - Service unit tests\n- `tests/integration/` - End-to-end workflows\n- `tests/helpers/` - Shared test utilities",
      "vector": [
        0.6862745098039216,
        0.3607843137254902,
        0.5372549019607843,
        0.7372549019607844,
        0.20784313725490197,
        0.7843137254901961,
        0.5647058823529412,
        0.6627450980392157,
        0.25882352941176473,
        0.3058823529411765,
        0.4470588235294118,
        0.6431372549019608,
        0.34509803921568627,
        0.0784313725490196,
        0.0196078431372549,
        0.7333333333333333,
        0.27058823529411763,
        0.4117647058823529,
        0.2823529411764706,
        0.48627450980392156,
        0.2980392156862745,
        0.9607843137254902,
        0.6431372549019608,
        0.42745098039215684,
        0.9019607843137255,
        0.17647058823529413,
        0.2627450980392157,
        0.2235294117647059,
        0.35294117647058826,
        0.9176470588235294,
        0.6980392156862745,
        0.6941176470588235,
        0.6862745098039216,
        0.3607843137254902,
        0.5372549019607843,
        0.7372549019607844,
        0.20784313725490197,
        0.7843137254901961,
        0.5647058823529412,
        0.6627450980392157,
        0.25882352941176473,
        0.3058823529411765,
        0.4470588235294118,
        0.6431372549019608,
        0.34509803921568627,
        0.0784313725490196,
        0.0196078431372549,
        0.7333333333333333,
        0.27058823529411763,
        0.4117647058823529,
        0.2823529411764706,
        0.48627450980392156,
        0.2980392156862745,
        0.9607843137254902,
        0.6431372549019608,
        0.42745098039215684,
        0.9019607843137255,
        0.17647058823529413,
        0.2627450980392157,
        0.2235294117647059,
        0.35294117647058826,
        0.9176470588235294,
        0.6980392156862745,
        0.6941176470588235
      ]
    },
    {
      "text": "Deduplication checklist:\n1. Search for similar test file names\n2. Compare test case names for duplicates\n3. Merge unique cases into canonical location\n4. Delete duplicate files\n\n### Security Tests as First-Class Citizens\n\nEvery security boundary needs explicit tests. Label security tests with `[security]` and include tests for path traversal, shell injection, network exfiltration, and env leakage.\n\n### Database Initialization\n\n✅ DO: Use `initTestDbService()` for DatabaseService tests. Prefer `initActivityTableSchema()` for reconnection tests and avoid raw SQL table creation in test files.\n\n### CLI Test Context — Recommended Pattern\n\nUse `createCliTestContext()` to centralize DB + tempdir setup for CLI tests. Always call returned `cleanup()` in `afterEach` to avoid leaking resources.",
      "vector": [
        0.10196078431372549,
        0.4235294117647059,
        0.1803921568627451,
        0.5647058823529412,
        0.22745098039215686,
        0.5294117647058824,
        0.3764705882352941,
        0.3607843137254902,
        0.2,
        0.6784313725490196,
        0.5803921568627451,
        0.3686274509803922,
        0.3254901960784314,
        0.9019607843137255,
        0.47058823529411764,
        0.6196078431372549,
        0.9333333333333333,
        0.7372549019607844,
        0.6784313725490196,
        0.08235294117647059,
        0.34901960784313724,
        0.4666666666666667,
        0.996078431372549,
        0.48627450980392156,
        0.07450980392156863,
        0.47843137254901963,
        0.22745098039215686,
        0.9137254901960784,
        0.9764705882352941,
        0.7294117647058823,
        0.396078431372549,
        0.6313725490196078,
        0.10196078431372549,
        0.4235294117647059,
        0.1803921568627451,
        0.5647058823529412,
        0.22745098039215686,
        0.5294117647058824,
        0.3764705882352941,
        0.3607843137254902,
        0.2,
        0.6784313725490196,
        0.5803921568627451,
        0.3686274509803922,
        0.3254901960784314,
        0.9019607843137255,
        0.47058823529411764,
        0.6196078431372549,
        0.9333333333333333,
        0.7372549019607844,
        0.6784313725490196,
        0.08235294117647059,
        0.34901960784313724,
        0.4666666666666667,
        0.996078431372549,
        0.48627450980392156,
        0.07450980392156863,
        0.47843137254901963,
        0.22745098039215686,
        0.9137254901960784,
        0.9764705882352941,
        0.7294117647058823,
        0.396078431372549,
        0.6313725490196078
      ]
    },
    {
      "text": "### Integration TestEnvironment — Recommended Pattern\n\nUse `TestEnvironment.create()` for full integration tests that require workspace layout, DB, and optional git initialization. Prefer small, focused integration tests that exercise end-to-end behavior with deterministic teardown.\n\n---",
      "vector": [
        0.33725490196078434,
        0.09019607843137255,
        0.5882352941176471,
        0.12156862745098039,
        0.0196078431372549,
        0.7294117647058823,
        0.28627450980392155,
        0.21176470588235294,
        0.047058823529411764,
        0.19215686274509805,
        0.5411764705882353,
        0.7294117647058823,
        0.5529411764705883,
        0.26666666666666666,
        0.16862745098039217,
        0.2196078431372549,
        0.3411764705882353,
        0.24313725490196078,
        0.3137254901960784,
        0.9294117647058824,
        0.4117647058823529,
        0.9803921568627451,
        0.2235294117647059,
        0.9490196078431372,
        0.8117647058823529,
        0.12549019607843137,
        0.4549019607843137,
        0.5254901960784314,
        0.2980392156862745,
        0.29411764705882354,
        0.47058823529411764,
        0.03137254901960784,
        0.33725490196078434,
        0.09019607843137255,
        0.5882352941176471,
        0.12156862745098039,
        0.0196078431372549,
        0.7294117647058823,
        0.28627450980392155,
        0.21176470588235294,
        0.047058823529411764,
        0.19215686274509805,
        0.5411764705882353,
        0.7294117647058823,
        0.5529411764705883,
        0.26666666666666666,
        0.16862745098039217,
        0.2196078431372549,
        0.3411764705882353,
        0.24313725490196078,
        0.3137254901960784,
        0.9294117647058824,
        0.4117647058823529,
        0.9803921568627451,
        0.2235294117647059,
        0.9490196078431372,
        0.8117647058823529,
        0.12549019607843137,
        0.4549019607843137,
        0.5254901960784314,
        0.2980392156862745,
        0.29411764705882354,
        0.47058823529411764,
        0.03137254901960784
      ]
    }
  ]
}