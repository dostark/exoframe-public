{
  "path": ".copilot/tests/jscpd-guide.md",
  "title": "jscpd Code Duplication Detection Guide",
  "vecs": [
    {
      "text": "# jscpd Code Duplication Detection Guide\n\n## Quick Start\n\n```bash\n# Basic scan of source and tests\nnpx jscpd src/ tests/\n\n# Generate JSON report for detailed analysis\nnpx jscpd src/ tests/ --reporters json --output ./jscpd-report\n\n# Scan specific directory\nnpx jscpd src/tui/\n\n# With HTML report\nnpx jscpd src/ tests/ --reporters html,json --output ./jscpd-report\n```\n\n## Command Options",
      "vector": [
        0.21568627450980393,
        0.21568627450980393,
        0.9019607843137255,
        0.21568627450980393,
        0.8156862745098039,
        0.39215686274509803,
        0.23529411764705882,
        0.19215686274509805,
        0.7725490196078432,
        0.6313725490196078,
        0.15294117647058825,
        0.3607843137254902,
        0.8470588235294118,
        0.1568627450980392,
        0.25882352941176473,
        0.6666666666666666,
        0.5098039215686274,
        0.6039215686274509,
        0.6823529411764706,
        0.5372549019607843,
        0.6901960784313725,
        0.3137254901960784,
        0.49411764705882355,
        0.27058823529411763,
        0.37254901960784315,
        0.4392156862745098,
        0.47058823529411764,
        0.9725490196078431,
        0.3215686274509804,
        0.08235294117647059,
        0.42745098039215684,
        0.9058823529411765,
        0.21568627450980393,
        0.21568627450980393,
        0.9019607843137255,
        0.21568627450980393,
        0.8156862745098039,
        0.39215686274509803,
        0.23529411764705882,
        0.19215686274509805,
        0.7725490196078432,
        0.6313725490196078,
        0.15294117647058825,
        0.3607843137254902,
        0.8470588235294118,
        0.1568627450980392,
        0.25882352941176473,
        0.6666666666666666,
        0.5098039215686274,
        0.6039215686274509,
        0.6823529411764706,
        0.5372549019607843,
        0.6901960784313725,
        0.3137254901960784,
        0.49411764705882355,
        0.27058823529411763,
        0.37254901960784315,
        0.4392156862745098,
        0.47058823529411764,
        0.9725490196078431,
        0.3215686274509804,
        0.08235294117647059,
        0.42745098039215684,
        0.9058823529411765
      ]
    },
    {
      "text": "| Option | Description | Example |\n|--------|-------------|---------|\n| `--min-lines` | Minimum lines to consider clone | `--min-lines 5` (default: 5) |\n| `--min-tokens` | Minimum tokens to consider clone | `--min-tokens 50` (default: 50) |\n| `--threshold` | Fail if duplication exceeds % | `--threshold 10` |\n| `--reporters` | Output formats | `json`, `html`, `console` |\n| `--ignore` | Patterns to ignore | `--ignore \"**/node_modules/**\"` |\n| `--format` | Languages to scan | `--format typescript` |\n\n## Understanding Output\n\n### Console Output\n```\nClone found (typescript):\n - tests/ai/openai_provider_test.ts [64:2 - 78:13] (14 lines, 136 tokens)\n   tests/ai/anthropic_provider_test.ts [44:2 - 56:12]\n```",
      "vector": [
        0.16862745098039217,
        0.34901960784313724,
        0.9294117647058824,
        0.2549019607843137,
        0.2784313725490196,
        0.8745098039215686,
        0.3215686274509804,
        0.38823529411764707,
        0.3764705882352941,
        0.8549019607843137,
        0.00392156862745098,
        0.8627450980392157,
        0.2196078431372549,
        0.12941176470588237,
        0.4549019607843137,
        0.7176470588235294,
        0.9647058823529412,
        0.07058823529411765,
        0.38823529411764707,
        0.12549019607843137,
        0.37254901960784315,
        0.10980392156862745,
        0.011764705882352941,
        0.23529411764705882,
        0.8549019607843137,
        0.1411764705882353,
        0.7764705882352941,
        0.06274509803921569,
        0.4470588235294118,
        0.5607843137254902,
        0.5019607843137255,
        0.8627450980392157,
        0.16862745098039217,
        0.34901960784313724,
        0.9294117647058824,
        0.2549019607843137,
        0.2784313725490196,
        0.8745098039215686,
        0.3215686274509804,
        0.38823529411764707,
        0.3764705882352941,
        0.8549019607843137,
        0.00392156862745098,
        0.8627450980392157,
        0.2196078431372549,
        0.12941176470588237,
        0.4549019607843137,
        0.7176470588235294,
        0.9647058823529412,
        0.07058823529411765,
        0.38823529411764707,
        0.12549019607843137,
        0.37254901960784315,
        0.10980392156862745,
        0.011764705882352941,
        0.23529411764705882,
        0.8549019607843137,
        0.1411764705882353,
        0.7764705882352941,
        0.06274509803921569,
        0.4470588235294118,
        0.5607843137254902,
        0.5019607843137255,
        0.8627450980392157
      ]
    },
    {
      "text": "Interpretation:\n- **File 1**: `openai_provider_test.ts`, lines 64-78\n- **File 2**: `anthropic_provider_test.ts`, lines 44-56\n- **Size**: 14 lines, 136 tokens (larger = higher priority for refactoring)\n\n### JSON Report Structure\n```json\n{\n  \"statistics\": {\n    \"total\": {\n      \"lines\": 78636,\n      \"clones\": 300,\n      \"duplicatedLines\": 3340,\n      \"percentage\": 4.2\n    }\n  },\n  \"duplicates\": [...]\n}\n```\n\n## Duplication Thresholds\n\n| Level | Percentage | Action |\n|-------|------------|--------|\n| ðŸŸ¢ Good | < 2% | No action needed |\n| ðŸŸ¡ Warning | 2-5% | Monitor, refactor when convenient |\n| ðŸŸ  High | 5-10% | Plan refactoring phase |\n| ðŸ”´ Critical | > 10% | Immediate attention required |\n\n### Per-File Thresholds",
      "vector": [
        0.4470588235294118,
        0.7372549019607844,
        0.011764705882352941,
        0.8352941176470589,
        0.9294117647058824,
        0.5215686274509804,
        0.36470588235294116,
        0.38823529411764707,
        0.00392156862745098,
        0.20784313725490197,
        0.6509803921568628,
        0.7529411764705882,
        0.8,
        0.7764705882352941,
        0.0196078431372549,
        0.21176470588235294,
        0.49411764705882355,
        0.9215686274509803,
        0.7333333333333333,
        0.5137254901960784,
        0.611764705882353,
        0.7764705882352941,
        0.3764705882352941,
        0.10196078431372549,
        0.803921568627451,
        0.6431372549019608,
        0.45098039215686275,
        0.0196078431372549,
        0.6549019607843137,
        0.2549019607843137,
        0.058823529411764705,
        0.41568627450980394,
        0.4470588235294118,
        0.7372549019607844,
        0.011764705882352941,
        0.8352941176470589,
        0.9294117647058824,
        0.5215686274509804,
        0.36470588235294116,
        0.38823529411764707,
        0.00392156862745098,
        0.20784313725490197,
        0.6509803921568628,
        0.7529411764705882,
        0.8,
        0.7764705882352941,
        0.0196078431372549,
        0.21176470588235294,
        0.49411764705882355,
        0.9215686274509803,
        0.7333333333333333,
        0.5137254901960784,
        0.611764705882353,
        0.7764705882352941,
        0.3764705882352941,
        0.10196078431372549,
        0.803921568627451,
        0.6431372549019608,
        0.45098039215686275,
        0.0196078431372549,
        0.6549019607843137,
        0.2549019607843137,
        0.058823529411764705,
        0.41568627450980394
      ]
    },
    {
      "text": "| Level | Percentage | Action |\n|-------|------------|--------|\n| ðŸŸ¢ Good | < 15% | Acceptable |\n| ðŸŸ¡ Warning | 15-30% | Consider helper extraction |\n| ðŸ”´ Critical | > 30% | Create extraction plan |\n\n## Common Duplication Patterns\n\n### 1. Test Setup Duplication\n```typescript\n// BAD: Repeated across test files\nconst { db, tempDir, cleanup } = await initTestDbService();\nconst context = createTestContext(db);\n// ... 10+ lines of setup\n\n// GOOD: Extract to helper\nconst ctx = await createTestFixture();\n```\n\n### 2. Provider Pattern Duplication\n```typescript\n// BAD: Same constructor in multiple providers\nconstructor(config: Config) {\n  this.apiKey = config.apiKey || Deno.env.get(\"API_KEY\");\n  this.model = config.model || DEFAULT_MODEL;\n}",
      "vector": [
        0.3254901960784314,
        0.788235294117647,
        0.6666666666666666,
        0.9333333333333333,
        0.8980392156862745,
        0.3333333333333333,
        0.3137254901960784,
        0.4745098039215686,
        0.9333333333333333,
        0.5411764705882353,
        0.4627450980392157,
        0.9921568627450981,
        0.06666666666666667,
        0.19607843137254902,
        0.3254901960784314,
        0.10196078431372549,
        0.6549019607843137,
        0.8274509803921568,
        0.22745098039215686,
        0.5686274509803921,
        0.803921568627451,
        0.09019607843137255,
        0.03137254901960784,
        0.6784313725490196,
        0.8745098039215686,
        0.08235294117647059,
        0.9019607843137255,
        0.07450980392156863,
        0.24313725490196078,
        0.16470588235294117,
        0.3176470588235294,
        0.1607843137254902,
        0.3254901960784314,
        0.788235294117647,
        0.6666666666666666,
        0.9333333333333333,
        0.8980392156862745,
        0.3333333333333333,
        0.3137254901960784,
        0.4745098039215686,
        0.9333333333333333,
        0.5411764705882353,
        0.4627450980392157,
        0.9921568627450981,
        0.06666666666666667,
        0.19607843137254902,
        0.3254901960784314,
        0.10196078431372549,
        0.6549019607843137,
        0.8274509803921568,
        0.22745098039215686,
        0.5686274509803921,
        0.803921568627451,
        0.09019607843137255,
        0.03137254901960784,
        0.6784313725490196,
        0.8745098039215686,
        0.08235294117647059,
        0.9019607843137255,
        0.07450980392156863,
        0.24313725490196078,
        0.16470588235294117,
        0.3176470588235294,
        0.1607843137254902
      ]
    },
    {
      "text": "// GOOD: Base class\nexport abstract class BaseProvider {\n  constructor(config: Config, defaults: Defaults) {\n    this.apiKey = config.apiKey || Deno.env.get(defaults.envKey);\n    this.model = config.model || defaults.defaultModel;\n  }\n}\n```\n\n### 3. Test Assertion Patterns\n```typescript\n// BAD: Same assertions repeated\nassertEquals(result.status, \"success\");\nassertEquals(result.data.length, 3);\nassertExists(result.timestamp);\n\n// GOOD: Custom assertion helper\nassertSuccessResult(result, { dataLength: 3 });\n```\n\n## Refactoring Workflow\n\n1. **Run jscpd** to identify duplicates\n   ```bash\n   npx jscpd src/ tests/ --reporters json --output ./jscpd-report\n   ```",
      "vector": [
        0.9921568627450981,
        0.2823529411764706,
        0.6745098039215687,
        0.8431372549019608,
        0.9333333333333333,
        0.6666666666666666,
        0.5568627450980392,
        0.8235294117647058,
        0.21568627450980393,
        0.9607843137254902,
        0.023529411764705882,
        0.9333333333333333,
        0.30980392156862746,
        0.10196078431372549,
        0.3568627450980392,
        0.6627450980392157,
        0.28627450980392155,
        0.6392156862745098,
        0.0784313725490196,
        0.7019607843137254,
        0.3607843137254902,
        0.5529411764705883,
        0.5529411764705883,
        0.47058823529411764,
        0.43529411764705883,
        0.41568627450980394,
        0.3058823529411765,
        0.8235294117647058,
        0.8156862745098039,
        0.2,
        0.4823529411764706,
        0.17647058823529413,
        0.9921568627450981,
        0.2823529411764706,
        0.6745098039215687,
        0.8431372549019608,
        0.9333333333333333,
        0.6666666666666666,
        0.5568627450980392,
        0.8235294117647058,
        0.21568627450980393,
        0.9607843137254902,
        0.023529411764705882,
        0.9333333333333333,
        0.30980392156862746,
        0.10196078431372549,
        0.3568627450980392,
        0.6627450980392157,
        0.28627450980392155,
        0.6392156862745098,
        0.0784313725490196,
        0.7019607843137254,
        0.3607843137254902,
        0.5529411764705883,
        0.5529411764705883,
        0.47058823529411764,
        0.43529411764705883,
        0.41568627450980394,
        0.3058823529411765,
        0.8235294117647058,
        0.8156862745098039,
        0.2,
        0.4823529411764706,
        0.17647058823529413
      ]
    },
    {
      "text": "2. **Prioritize** by tokens (larger = more impact)\n   ```bash\n   grep -o '\"duplicatedTokens\": [0-9]*' jscpd-report/jscpd-report.json | sort -t: -k2 -nr | head -20\n   ```\n\n3. **Analyze** specific clones\n   ```bash\n   grep -B15 'filename.ts' jscpd-report/jscpd-report.json\n   ```\n\n4. **Plan extraction** based on pattern type:\n   - Same file duplication â†’ Extract method\n   - Cross-file duplication â†’ Extract helper/utility\n   - Test duplication â†’ Create test helper or fixture\n\n5. **Implement** with tests first:\n   - Create helper with tests\n   - Refactor one usage\n   - Verify tests pass\n   - Refactor remaining usages\n\n6. **Verify** duplication reduced:\n   ```bash\n   npx jscpd src/ tests/ --reporters json --output ./jscpd-report-after\n   ```\n\n## Integration with CI",
      "vector": [
        0.12156862745098039,
        0.6862745098039216,
        0.36470588235294116,
        0.6588235294117647,
        0.12941176470588237,
        0.5803921568627451,
        0.48627450980392156,
        0.8392156862745098,
        0.03529411764705882,
        0.5490196078431373,
        0.7764705882352941,
        0.33725490196078434,
        0.9254901960784314,
        0.6941176470588235,
        0.08627450980392157,
        0.054901960784313725,
        0.6627450980392157,
        0.11764705882352941,
        0.4,
        0.8470588235294118,
        0.9882352941176471,
        0.3058823529411765,
        0.5686274509803921,
        0.06666666666666667,
        0.44313725490196076,
        0.6313725490196078,
        0.9137254901960784,
        0.2901960784313726,
        0.9098039215686274,
        0.5607843137254902,
        0.39215686274509803,
        0.7529411764705882,
        0.12156862745098039,
        0.6862745098039216,
        0.36470588235294116,
        0.6588235294117647,
        0.12941176470588237,
        0.5803921568627451,
        0.48627450980392156,
        0.8392156862745098,
        0.03529411764705882,
        0.5490196078431373,
        0.7764705882352941,
        0.33725490196078434,
        0.9254901960784314,
        0.6941176470588235,
        0.08627450980392157,
        0.054901960784313725,
        0.6627450980392157,
        0.11764705882352941,
        0.4,
        0.8470588235294118,
        0.9882352941176471,
        0.3058823529411765,
        0.5686274509803921,
        0.06666666666666667,
        0.44313725490196076,
        0.6313725490196078,
        0.9137254901960784,
        0.2901960784313726,
        0.9098039215686274,
        0.5607843137254902,
        0.39215686274509803,
        0.7529411764705882
      ]
    },
    {
      "text": "Add to pre-commit or CI pipeline:\n```bash\n# Fail if duplication > 5%\nnpx jscpd src/ tests/ --threshold 5\n\n# Or specific directories\nnpx jscpd src/ai/ --threshold 3\n```\n\n## ExoFrame-Specific Patterns\n\n### Test Helper Locations\n- `tests/helpers/` - General test utilities\n- `tests/cli/helpers/` - CLI test setup\n- `tests/integration/helpers/` - Integration test environment\n- `tests/tui/helpers.ts` - TUI mocks and harnesses\n- `tests/mcp/helpers/` - MCP server test setup\n\n### When NOT to Deduplicate\n\n1. **Intentional isolation** - Security tests should be standalone\n2. **Test clarity** - Some repetition improves test readability\n3. **Evolution** - Tests that may diverge should stay separate\n4. **Small clones** - < 50 tokens rarely worth extracting\n\n## Current Status (2026-01-04)",
      "vector": [
        0.09803921568627451,
        0.4235294117647059,
        0.9803921568627451,
        0.2823529411764706,
        0.49411764705882355,
        0.8392156862745098,
        0.8941176470588236,
        0.7450980392156863,
        0.2823529411764706,
        0.9254901960784314,
        0.054901960784313725,
        0.5764705882352941,
        0.6941176470588235,
        0.2235294117647059,
        0.8352941176470589,
        0.043137254901960784,
        0.7372549019607844,
        0.6627450980392157,
        0.40784313725490196,
        0.9490196078431372,
        0.30980392156862746,
        0.807843137254902,
        0.9019607843137255,
        0.2823529411764706,
        0.4117647058823529,
        0.5215686274509804,
        0.38823529411764707,
        0.7725490196078432,
        0.1568627450980392,
        0.058823529411764705,
        0.8470588235294118,
        0.39215686274509803,
        0.09803921568627451,
        0.4235294117647059,
        0.9803921568627451,
        0.2823529411764706,
        0.49411764705882355,
        0.8392156862745098,
        0.8941176470588236,
        0.7450980392156863,
        0.2823529411764706,
        0.9254901960784314,
        0.054901960784313725,
        0.5764705882352941,
        0.6941176470588235,
        0.2235294117647059,
        0.8352941176470589,
        0.043137254901960784,
        0.7372549019607844,
        0.6627450980392157,
        0.40784313725490196,
        0.9490196078431372,
        0.30980392156862746,
        0.807843137254902,
        0.9019607843137255,
        0.2823529411764706,
        0.4117647058823529,
        0.5215686274509804,
        0.38823529411764707,
        0.7725490196078432,
        0.1568627450980392,
        0.058823529411764705,
        0.8470588235294118,
        0.39215686274509803
      ]
    },
    {
      "text": "- **Total clones**: 300\n- **Duplicated lines**: 3,340 (4.2%)\n- **Highest duplication files**:\n  - `tests/ai/openai_provider_test.ts` (127%)\n  - `tests/ai/anthropic_provider_test.ts` (91%)\n  - `tests/services/request_router_test.ts` (78%)\n\nSee [phase-14-code-deduplication.md](../planning/phase-14-code-deduplication.md) for refactoring plan.\n\n## References\n\n- [jscpd GitHub](https://github.com/kucherenko/jscpd)\n- [Testing Guidelines](testing.md)\n- [Phase 14 Refactoring Plan](../planning/phase-14-code-deduplication.md)",
      "vector": [
        0.027450980392156862,
        0.09803921568627451,
        0.5176470588235295,
        0.7019607843137254,
        0.34901960784313724,
        0.807843137254902,
        0.6,
        0.6745098039215687,
        0.011764705882352941,
        0.12941176470588237,
        0.07450980392156863,
        0.41568627450980394,
        0.2196078431372549,
        0.9490196078431372,
        0.39215686274509803,
        0.44313725490196076,
        0.4549019607843137,
        0.8666666666666667,
        0.6705882352941176,
        0.5607843137254902,
        0.6784313725490196,
        0.7607843137254902,
        0.8745098039215686,
        0.6784313725490196,
        0.788235294117647,
        0.3843137254901961,
        0.3137254901960784,
        0.7176470588235294,
        0.8156862745098039,
        0.37254901960784315,
        0.4588235294117647,
        0.027450980392156862,
        0.027450980392156862,
        0.09803921568627451,
        0.5176470588235295,
        0.7019607843137254,
        0.34901960784313724,
        0.807843137254902,
        0.6,
        0.6745098039215687,
        0.011764705882352941,
        0.12941176470588237,
        0.07450980392156863,
        0.41568627450980394,
        0.2196078431372549,
        0.9490196078431372,
        0.39215686274509803,
        0.44313725490196076,
        0.4549019607843137,
        0.8666666666666667,
        0.6705882352941176,
        0.5607843137254902,
        0.6784313725490196,
        0.7607843137254902,
        0.8745098039215686,
        0.6784313725490196,
        0.788235294117647,
        0.3843137254901961,
        0.3137254901960784,
        0.7176470588235294,
        0.8156862745098039,
        0.37254901960784315,
        0.4588235294117647,
        0.027450980392156862
      ]
    }
  ]
}